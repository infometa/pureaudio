# DeepFilterNet 实时音频处理系统优化方案（Audit V2）

## 目标与范围
- 解决“外部设备已做 ANC/高频缺失”场景下的过度降噪和音色损伤。
- 保留自动适应能力，但增加显式开关与安全护栏；用户不开启时链路保持稳定。
- 兼顾可落地性：优先实现小步改动，可在现有代码基础上渐进上线。

## 问题回顾（基于 V1 与现状）
- 环境自适应逻辑粗糙，易误判，且默认开启/关闭不一致。
- 外部 ANC 场景未识别，叠加降噪导致高频被抹、音质变暗。
- 多级保护（headroom + BusLimiter + EQ 软限幅 + 最终限幅）虽不必然过压，但可精简阈值。
- 参数调节体验：滑块缺手输（已加）、配置分散（准备统一到 `audio/config.json`）。

## 新方案概要
1) **自动环境适应开关（默认关闭）**  
   - UI 暴露 “自动环境适应” toggle，默认关。开启后才启用规则调参。
2) **双模式规则：正常模式 / 柔和模式**  
   - 正常模式：现有参数（atten_lim≈30、df_mix≈0.9 等）。  
   - 柔和模式（用于外部 ANC/极静环境）：atten_lim 20–25，df_mix 0.85–0.9，post_filter_beta=0，高通不抬，高频补偿轻推（EQ 高架 +1~2 dB），旁路瞬态/饱和。
3) **触发逻辑（自动模式开启时）**  
   - 噪声基线检测：持续数秒 RMS < -60 dB 且谱重心下降，判定“外部 ANC/极静”，切到柔和模式；噪声升高再回正常模式。  
   - 高频保护：监测 DF 输出 vs 输入在 8–12 kHz 的能量差，若持续差值 > 6 dB，则逐步提高 df_mix（多混干声）或降低 atten_lim，直至差值回落。  
   - 切换滞后+平滑：每类状态需持续 N 帧（例如 2–3 秒）才切换，参数用平滑过渡，避免频繁跳变。
4) **限幅策略微调**  
   - 保留 BusLimiter + 最终限幅；EQ 软限幅阈值已提升（0.97/0.995），默认只在严重过载触发。  
   - headroom/post_trim 默认 0.9/1.0，如需精简可考虑把 headroom=1.0（由 BusLimiter 兜底）。
5) **谐波补偿**  
   - 保留轻量谐波激励（高频带通 + 温和饱和 + Mix），默认开启低强度，模式切换时可调 Mix：正常模式 25%，柔和模式 15%，避免刺耳。
6) **配置与体验**  
   - 默认配置集中到 `demo/audio/config.json`，便于快速回滚/分发。  
   - 滑块支持手输已完成；继续保持“一键旁路后处理”用于 A/B。

## 落地步骤（小步快跑）
P0（1 天内）  
- UI 增加“自动环境适应”开关，默认关闭；代码侧以此为唯一入口启用自动逻辑。  
- 将当前“柔和模式/正常模式”参数集合固化，存于 config，链路在自动逻辑中调用。

P1（1–2 天）  
- 实现噪声基线检测 + 高频保护的双阈值切换与平滑；加入滞后计数，避免抖动。  
- 自动模式下：在柔和/正常模式间切换，并相应调整谐波激励 Mix。

P2（可选，后续优化）  
- 微调限幅组合（视听感决定是否把 headroom 固定为 1.0）。  
- 优化外部 ANC 识别：增加“高频骤降 + 底噪极低”特征，避免误判。  
- 将自动模式参数范围暴露为配置（便于运维调参）。

## 风险与缓解
- 误判导致频繁切换：用滞后和平滑，必要时增加日志/指标观测。  
- 柔和模式降噪不足：保留手动模式与一键旁路，用户可快速回退。  
- 谐波激励过亮：限定 Mix 和 Drive 上限，模式切换时逐步插值。

## 现有工作承接
- 滑块手输已上线；EQ 软限幅阈值已抬高；输出重采样清零已优化。  
- 谐波激励已接入链路，可直接挂钩模式切换调节 Mix。

## 指标与验收
- 高频能量差（8–12 kHz）相对 raw 的平均提升，不超过 +3 dB 且无明显底噪提升。  
- 自动模式下的切换次数/分钟 < 1（平稳）。  
- 主观听感：外部 ANC + DF 同开时，比当前版本更自然、不闷不刺。
