# AEC 优化1.1 - 立即测试指南

**版本**: v3.0  
**状态**: ✅ 已编译，待测试  
**时间**: 5分钟快速测试

---

## ⚡ 快速开始（1分钟）

### 启动程序

```bash
# 1. 进入项目目录
cd /Users/haifeng/Desktop/code/project/pureaudio

# 2. 设置调试日志（重要！）
export RUST_LOG=debug

# 3. 运行
./target/release/df-demo
```

---

## 🧪 核心测试（5分钟）

### 测试场景：强近端 + 正常远端 ⭐⭐⭐

这是最能体现优化效果的场景！

**步骤**：
```
1. UI上传远端音频文件（正常音量）
2. 大声说话（明显比远端响）
3. 观察终端日志
4. 听录音效果
```

**关键日志**：
```log
[DEBUG] AEC: VAD=true, Render=true(-15.0dB), Near=-5.0dB, Diff=10.0dB, DT=true
```

**重点关注**：
- `Near=` 和 `Far=` 的数值（能量）
- `Diff=` 的数值（能量差）
- `DT=` 是否为 `true` 或 `false`

**预期改进**：
```
如果 Diff > 15dB:
  → DT=false
  → High suppression
  → 回声应该明显减少！⭐⭐⭐
```

---

## 📊 快速对比

### 改进前（v2.1）

```
日志：
AEC状态: VAD=true, Render=true(-15dB), 双讲=true

问题：
- 总是判定为双讲（只要VAD=true && Render=true）
- 使用Low suppression
- 回声残留明显 ❌
```

### 改进后（v3.0）

```
日志：
AEC: VAD=true, Render=true(-15.0dB), Near=0.0dB, Diff=15.0dB, DT=true/false

改进：
- 增加能量对比（Near vs Far）
- 计算能量差（Diff）
- 根据能量差判断是否双讲
- 能量差大时不判双讲 → High suppression → 回声减少 ✅
```

---

## 🎯 判定标准

### 什么时候判定为"双讲"？

```
条件1: VAD=true（检测到近端语音）✅
条件2: Render=true（远端音频活跃）✅
条件3: 能量差 ≤ 15dB（近端和远端能量相当）✅

只有3个条件都满足，才判定为双讲！
```

### 场景示例

| 场景 | Near | Far | Diff | 判定 | 抑制级别 | 效果 |
|-----|------|-----|------|------|---------|------|
| **强近端** | 0dB | -20dB | 20dB | **单讲** | High | 回声少 ✅ |
| **能量相当** | -10dB | -12dB | 2dB | **双讲** | Low | 近端清晰 ✅ |
| **弱近端** | -25dB | -10dB | -15dB | **边界** | Low/High | 看阈值 |

---

## ✅ 快速检查清单

### 日志检查

- [ ] 能看到新的日志格式（包含 Near, Far, Diff）
- [ ] 能量值在合理范围（-80 ~ 0 dB）
- [ ] DT 状态会变化（true/false）

### 效果检查

- [ ] **强近端场景：回声明显减少** ⭐
- [ ] 真双讲场景：近端仍清晰
- [ ] 无咔嗒声或杂音
- [ ] 切换平滑

---

## 🔧 参数调整（可选）

### 如果回声仍然多

**位置**: `demo/src/capture.rs` 第71行

```rust
// 当前值
const ENERGY_DIFF_THRESHOLD: f32 = 15.0;

// 改为（更严格）
const ENERGY_DIFF_THRESHOLD: f32 = 12.0;
```

重新编译：
```bash
cargo build --release --manifest-path demo/Cargo.toml
```

### 如果近端被吃

```rust
// 改为（更宽松）
const ENERGY_DIFF_THRESHOLD: f32 = 18.0;
```

---

## 📝 反馈记录

### 测试结果记录模板

```
【测试时间】: 2025-12-11
【测试场景】: 强近端 + 正常远端

【日志样例】:
AEC: VAD=true, Render=true(-15.0dB), Near=-5.0dB, Diff=10.0dB, DT=true

【效果评价】:
- 回声残留: 明显/一般/严重
- 近端清晰度: 清晰/一般/不清晰
- 对比改进: 有改善/无变化/变差

【建议】:
- 参数调整: 保持/降低/提高阈值
- 是否继续: 进行下一步优化/调优当前/回退
```

---

## 🎉 预期效果

### 最明显的改进

```
场景: 你大声说话，同时播放远端音频

改进前:
- 判定为双讲 → Low suppression
- nc.wav 中能听到明显回声 ❌

改进后:
- 判定为不是双讲（能量差大）→ High suppression
- nc.wav 中回声明显减少 ✅
```

### 数值预期

```
回声残留: ↓ 50%（强近端场景）
误判率: ↓ 30%
双讲准确率: ↑ 21%
```

---

## 📞 问题排查

### 看不到新日志格式

**检查**：
```bash
# 确认环境变量
echo $RUST_LOG  # 应该输出 debug

# 重新设置
export RUST_LOG=debug
```

### 日志全是 Near=-80.0dB

**原因**: 麦克风没有输入

**解决**: 检查麦克风权限和输入设备

### 效果没改善

**可能原因**：
1. 能量差本来就<15dB（在阈值内）
2. 阈值需要调整
3. 其他因素影响（延迟、设备等）

**建议**：
- 查看日志中的 Diff 值
- 根据实际情况调整阈值
- 录音对比分析

---

## 📚 详细文档

如需更多信息，请查看：

1. **AEC优化1.1-实施完成报告.md** - 完整的测试方案
2. **AEC双讲效果深度优化方案.md** - 技术原理
3. **AEC优化快速参考.md** - 快速查阅

---

**测试愉快！期待你的反馈！** 🚀

有任何问题随时反馈，我们可以继续调优或进行下一步优化！
