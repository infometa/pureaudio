# AEC åŒè®²åéŸ³é—®é¢˜å®¡è®¡æŠ¥å‘Š v2ï¼ˆä¿®å¤åï¼‰

## ä¿®å¤ç¡®è®¤

### âœ… å·²ä¿®å¤çš„é—®é¢˜

1. **åŒè®²ä¿æŠ¤çª—å£** - å·²ä» 40ms å¢åŠ åˆ° 200-300msï¼ˆè‡ªé€‚åº”ï¼‰
2. **åŸºäºèƒ½é‡çš„å¤‡ç”¨æ£€æµ‹** - å·²æ·»åŠ ï¼ˆä¸ä¾èµ– VADï¼‰
3. **æŒ‡æ•°è¡°å‡** - å·²å®ç°åˆ†æ®µè¡°å‡
4. **åŒè®²é€€å‡ºè¿‡æ¸¡** - å·²æ·»åŠ  `dt_exit_frames` è¿‡æ¸¡æœŸ

---

## å½“å‰é—®é¢˜åˆ—è¡¨

### ğŸ”´ **AEC-DT-BUG-007: èƒ½é‡æ£€æµ‹é˜ˆå€¼ä¸å¤Ÿå‡†ç¡®ï¼Œå¯èƒ½è¯¯åˆ¤**

**ä½ç½®**: `capture.rs:1995`

**é—®é¢˜**:
```rust
let energy_voice = rms_db > -40.0;
let dt_detected = (vad_enabled && vad_state) || (!vad_enabled && energy_voice);
```

**åˆ†æ**:
- èƒ½é‡æ£€æµ‹åªæ£€æŸ¥äº† `rms_db > -40.0`
- **æ²¡æœ‰æ£€æŸ¥ SNR**ï¼ˆ`snr_db`ï¼‰ï¼Œå¯èƒ½å°†å™ªå£°è¯¯åˆ¤ä¸ºè¯­éŸ³
- **æ²¡æœ‰æ£€æŸ¥èƒ½é‡å·®**ï¼ˆ`energy_gap`ï¼‰ï¼Œå¯èƒ½å°†èƒŒæ™¯å™ªå£°è¯¯åˆ¤ä¸ºè¯­éŸ³
- åœ¨å˜ˆæ‚ç¯å¢ƒä¸­ï¼Œå³ä½¿æ²¡æœ‰è¯­éŸ³ï¼Œ`rms_db` ä¹Ÿå¯èƒ½ > -40.0
- `snr_db` å’Œ `energy_gap` åœ¨åŒè®²æ£€æµ‹ä¹‹å‰å·²ç»è®¡ç®—å¥½ï¼ˆ`capture.rs:1492, 1433`ï¼‰ï¼Œä½†åœ¨åŒè®²æ£€æµ‹æ—¶ï¼ˆ`capture.rs:1995`ï¼‰é‡æ–°è®¡ç®—äº† `rms_db`ï¼Œ**æ²¡æœ‰ä½¿ç”¨å·²æœ‰çš„ `snr_db` å’Œ `energy_gap`**

**å½±å“**:
- åœ¨å˜ˆæ‚ç¯å¢ƒä¸­ï¼Œå¯èƒ½è¯¯è§¦å‘åŒè®²ä¿æŠ¤
- å¯¼è‡´ AEC æŠ‘åˆ¶ä¸è¶³ï¼Œå›å£°æ®‹ç•™
- åœ¨å®‰é™ç¯å¢ƒä¸­ï¼Œå¯èƒ½æ— æ³•æ­£ç¡®æ£€æµ‹åŒè®²

**ä¿®å¤å»ºè®®**:
```rust
// æ·»åŠ  SNR å’Œèƒ½é‡å·®æ£€æŸ¥ï¼ˆéœ€è¦å…ˆè®¡ç®— energy_gapï¼‰
let energy_gap = rms_db - noise_floor_db;
let energy_voice = rms_db > -40.0 && snr_db > 8.0 && energy_gap > 10.0;
let dt_detected = (vad_enabled && vad_state) || (!vad_enabled && energy_voice);
```

**æ³¨æ„**: `snr_db` å’Œ `noise_floor_db` åœ¨åŒè®²æ£€æµ‹æ—¶å·²ç»å¯ç”¨ï¼ˆåœ¨å¤„ç†å¾ªç¯å¼€å§‹æ—¶å®šä¹‰ï¼‰ï¼Œä½† `energy_gap` éœ€è¦é‡æ–°è®¡ç®—ã€‚

**ä¼˜å…ˆçº§**: **é«˜**

---

### ğŸŸ¡ **AEC-DT-BUG-008: åŒè®²æ£€æµ‹æ²¡æœ‰è€ƒè™‘ render ä¿¡å·çš„èƒ½é‡**

**ä½ç½®**: `capture.rs:1997`

**é—®é¢˜**:
```rust
if dt_detected && render_active {
    // åŒè®²ä¿æŠ¤
}
```

**åˆ†æ**:
- `render_active` åªæ£€æŸ¥äº† render ä¿¡å·æ˜¯å¦å­˜åœ¨ï¼ˆ`!mute_playback` æˆ– `auto_play_buffer` å­˜åœ¨ï¼‰
- **æ²¡æœ‰æ£€æŸ¥ render ä¿¡å·çš„å®é™…èƒ½é‡**
- å¦‚æœ render ä¿¡å·å¾ˆå¼±ï¼ˆå‡ ä¹å¬ä¸åˆ°ï¼‰ï¼Œå¯èƒ½ä¸æ˜¯çœŸæ­£çš„åŒè®²
- å¦‚æœ render ä¿¡å·å¾ˆå¼ºï¼Œåº”è¯¥æ›´ç§¯æåœ°ä¿æŠ¤æœ¬åœ°è¯­éŸ³

**å½±å“**:
- å¼± render ä¿¡å·æ—¶ï¼Œå¯èƒ½è¯¯è§¦å‘åŒè®²ä¿æŠ¤
- å¼º render ä¿¡å·æ—¶ï¼ŒåŒè®²ä¿æŠ¤å¯èƒ½ä¸å¤Ÿ

**ä¿®å¤å»ºè®®**:
```rust
// æ£€æŸ¥ render ä¿¡å·çš„èƒ½é‡
let render_energy = calculate_render_energy(buffer); // éœ€è¦å®ç°
let render_strong = render_energy > -45.0; // render ä¿¡å·è¾ƒå¼º

// åªæœ‰åœ¨ render ä¿¡å·è¾ƒå¼ºæ—¶æ‰è§¦å‘åŒè®²ä¿æŠ¤
if dt_detected && render_active && render_strong {
    // åŒè®²ä¿æŠ¤
} else if dt_detected && render_active && !render_strong {
    // render ä¿¡å·è¾ƒå¼±ï¼Œä½¿ç”¨æ›´çŸ­çš„ä¿æŠ¤çª—å£
    let short_window: u16 = 10; // 100ms
    dt_bypass_frames = dt_bypass_frames.max(short_window);
}
```

**ä¼˜å…ˆçº§**: **ä¸­**

---

### ğŸŸ¡ **AEC-DT-BUG-009: è‡ªé€‚åº”çª—å£è®¡ç®—å¯èƒ½æº¢å‡º**

**ä½ç½®**: `capture.rs:1999-2001`

**é—®é¢˜**:
```rust
let energy_factor = ((rms_db + 60.0) / 30.0).clamp(0.0, 1.2);
let base_window: u16 = 20; // 200ms
let adaptive = (base_window as f32 * (1.0 + 0.5 * energy_factor)) as u16;
```

**åˆ†æ**:
- `energy_factor` æœ€å¤§ä¸º 1.2
- `adaptive = 20 * (1.0 + 0.5 * 1.2) = 20 * 1.6 = 32`
- 32 å¸§ = 320msï¼Œåœ¨ `u16` èŒƒå›´å†…ï¼Œä¸ä¼šæº¢å‡º
- ä½†å¦‚æœ `rms_db` å¾ˆå¤§ï¼ˆå¦‚ -20.0ï¼‰ï¼Œ`energy_factor` å¯èƒ½è¶…è¿‡ 1.2ï¼ˆè™½ç„¶å·² clampï¼‰
- è®¡ç®—çœ‹èµ·æ¥æ˜¯å®‰å…¨çš„ï¼Œä½†éœ€è¦ç¡®è®¤

**å½±å“**:
- å¦‚æœè®¡ç®—æº¢å‡ºï¼Œå¯èƒ½å¯¼è‡´ä¿æŠ¤çª—å£å¼‚å¸¸

**ä¼˜å…ˆçº§**: **ä½**ï¼ˆå½“å‰å®ç°çœ‹èµ·æ¥æ˜¯å®‰å…¨çš„ï¼‰

---

### ğŸŸ¢ **AEC-DT-BUG-010: è¡°å‡é€»è¾‘ä¸­ frame_counter çš„ä½¿ç”¨**

**ä½ç½®**: `capture.rs:2008`

**é—®é¢˜**:
```rust
if frame_counter % 2 == 0 {
    dt_bypass_frames = dt_bypass_frames.saturating_sub(1);
}
```

**åˆ†æ**:
- `frame_counter` æ˜¯å…¨å±€å¸§è®¡æ•°ï¼Œæ¯å¸§é€’å¢
- ä½¿ç”¨ `frame_counter % 2 == 0` æ¥å®ç°æ¯ 2 å¸§å‡ 1
- è¿™æ˜¯æ­£ç¡®çš„å®ç°
- ä½†å¦‚æœ `frame_counter` æ²¡æœ‰æ­£ç¡®åˆå§‹åŒ–æˆ–é€’å¢ï¼Œå¯èƒ½å¯¼è‡´é—®é¢˜

**æ£€æŸ¥**:
- `frame_counter` åœ¨ `capture.rs:946` åˆå§‹åŒ–ä¸º 0
- åœ¨ `capture.rs:1074` æ¯å¸§é€’å¢ï¼š`frame_counter = frame_counter.wrapping_add(1);`
- å®ç°çœ‹èµ·æ¥æ˜¯æ­£ç¡®çš„

**ä¼˜å…ˆçº§**: **ä½**ï¼ˆå½“å‰å®ç°çœ‹èµ·æ¥æ˜¯æ­£ç¡®çš„ï¼‰

---

### ğŸŸ¢ **AEC-DT-BUG-011: åŒè®²é€€å‡ºè¿‡æ¸¡æœŸå¯èƒ½ä¸å¤Ÿ**

**ä½ç½®**: `audio/aec.rs:116`

**é—®é¢˜**:
```rust
if self.double_talk && !active {
    // åŒè®²é€€å‡ºåä¿ç•™ä¸€å°æ®µè¿‡æ¸¡ï¼Œé¿å…ç«‹å³åˆ‡å›é«˜æŠ‘åˆ¶å¯¼è‡´åéŸ³
    self.dt_exit_frames = self.dt_exit_frames.max(8);
}
```

**åˆ†æ**:
- åŒè®²é€€å‡ºè¿‡æ¸¡æœŸåªæœ‰ 8 å¸§ = 80ms
- è¿™ä¸ªè¿‡æ¸¡æœŸå¯èƒ½ä¸å¤Ÿï¼Œç‰¹åˆ«æ˜¯å¦‚æœä» Low æŠ‘åˆ¶çº§åˆ«çªç„¶åˆ‡æ¢åˆ° High æŠ‘åˆ¶çº§åˆ«
- 80ms çš„è¿‡æ¸¡æœŸå¯èƒ½æ— æ³•å®Œå…¨é¿å…åéŸ³

**å½±å“**:
- åŒè®²é€€å‡ºåï¼Œå¯èƒ½ä»ç„¶ä¼šæœ‰è½»å¾®çš„åéŸ³

**ä¿®å¤å»ºè®®**:
```rust
// å¢åŠ è¿‡æ¸¡æœŸ
if self.double_talk && !active {
    self.dt_exit_frames = self.dt_exit_frames.max(15); // 150ms è¿‡æ¸¡æœŸ
}
```

**ä¼˜å…ˆçº§**: **ä½**

---

### ğŸŸ¢ **AEC-DT-BUG-012: è‡ªåŠ¨å¼ºåŠ›æ¨¡å¼å¯èƒ½å½±å“åŒè®²ä¿æŠ¤**

**ä½ç½®**: `capture.rs:2037-2039`

**é—®é¢˜**:
```rust
if render_active && !dt_active && !vad_state {
    desired_aggressive = true;
}
```

**åˆ†æ**:
- å½“æœ‰ render ä¿¡å·ã€æ²¡æœ‰åŒè®²ã€æ²¡æœ‰æœ¬åœ°è¯­éŸ³æ—¶ï¼Œè‡ªåŠ¨å¯ç”¨å¼ºåŠ›æ¨¡å¼
- è¿™æ˜¯åˆç†çš„ï¼Œå¯ä»¥æ›´ç§¯æåœ°æ¶ˆé™¤å›å£°
- ä½†å¦‚æœåŒè®²æ£€æµ‹æœ‰å»¶è¿Ÿï¼Œå¯èƒ½åœ¨åŒè®²åˆšå¼€å§‹æ—¶ä»ç„¶ä½¿ç”¨å¼ºåŠ›æ¨¡å¼
- å¯¼è‡´è¯­éŸ³èµ·éŸ³è¢«å

**å½±å“**:
- åŒè®²åˆšå¼€å§‹æ—¶ï¼Œå¯èƒ½ä»ç„¶ä½¿ç”¨å¼ºåŠ›æ¨¡å¼ï¼Œå¯¼è‡´è¯­éŸ³èµ·éŸ³è¢«å

**ä¿®å¤å»ºè®®**:
```rust
// æ·»åŠ åŒè®²æ£€æµ‹çš„æ»åä¿æŠ¤
let dt_recent = dt_bypass_frames > 0 || (dt_bypass_frames == 0 && last_dt_exit.elapsed() < Duration::from_millis(100));
if render_active && !dt_recent && !vad_state {
    desired_aggressive = true;
}
```

**ä¼˜å…ˆçº§**: **ä½**

---

## é—®é¢˜æ±‡æ€»

### é«˜ä¼˜å…ˆçº§é—®é¢˜

1. **AEC-DT-BUG-007**: èƒ½é‡æ£€æµ‹é˜ˆå€¼ä¸å¤Ÿå‡†ç¡®ï¼Œå¯èƒ½è¯¯åˆ¤ï¼ˆæ²¡æœ‰æ£€æŸ¥ SNR å’Œèƒ½é‡å·®ï¼‰

### ä¸­ä¼˜å…ˆçº§é—®é¢˜

2. **AEC-DT-BUG-008**: åŒè®²æ£€æµ‹æ²¡æœ‰è€ƒè™‘ render ä¿¡å·çš„èƒ½é‡

### ä½ä¼˜å…ˆçº§é—®é¢˜

3. **AEC-DT-BUG-009**: è‡ªé€‚åº”çª—å£è®¡ç®—å¯èƒ½æº¢å‡ºï¼ˆå½“å‰å®ç°çœ‹èµ·æ¥æ˜¯å®‰å…¨çš„ï¼‰
4. **AEC-DT-BUG-010**: è¡°å‡é€»è¾‘ä¸­ frame_counter çš„ä½¿ç”¨ï¼ˆå½“å‰å®ç°çœ‹èµ·æ¥æ˜¯æ­£ç¡®çš„ï¼‰
5. **AEC-DT-BUG-011**: åŒè®²é€€å‡ºè¿‡æ¸¡æœŸå¯èƒ½ä¸å¤Ÿï¼ˆåªæœ‰ 80msï¼‰
6. **AEC-DT-BUG-012**: è‡ªåŠ¨å¼ºåŠ›æ¨¡å¼å¯èƒ½å½±å“åŒè®²ä¿æŠ¤

---

## ä¼˜åŒ–å»ºè®®

### å»ºè®® 1: æ”¹è¿›èƒ½é‡æ£€æµ‹ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

**ä½ç½®**: `capture.rs:1995`

**å½“å‰ä»£ç **:
```rust
let energy_voice = rms_db > -40.0;
```

**ä¿®å¤**:
```rust
// æ·»åŠ  SNR å’Œèƒ½é‡å·®æ£€æŸ¥
let energy_voice = rms_db > -40.0 && snr_db > 8.0 && energy_gap > 10.0;
```

**é¢„æœŸæ•ˆæœ**: å‡å°‘è¯¯åˆ¤ï¼Œæé«˜åŒè®²æ£€æµ‹çš„å‡†ç¡®æ€§

---

### å»ºè®® 2: è€ƒè™‘ render ä¿¡å·èƒ½é‡ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

**ä½ç½®**: `capture.rs:1997`

**å½“å‰ä»£ç **:
```rust
if dt_detected && render_active {
    // åŒè®²ä¿æŠ¤
}
```

**ä¿®å¤**:
```rust
// æ£€æŸ¥ render ä¿¡å·çš„èƒ½é‡
let render_peak = buffer.iter().fold(0.0f32, |acc, v| acc.max(v.abs()));
let render_energy_db = 20.0 * render_peak.max(1e-9).log10();
let render_strong = render_energy_db > -45.0;

if dt_detected && render_active {
    if render_strong {
        // render ä¿¡å·è¾ƒå¼ºï¼Œä½¿ç”¨å®Œæ•´ä¿æŠ¤çª—å£
        dt_bypass_frames = dt_bypass_frames.max(adaptive.max(base_window));
    } else {
        // render ä¿¡å·è¾ƒå¼±ï¼Œä½¿ç”¨æ›´çŸ­çš„ä¿æŠ¤çª—å£
        let short_window: u16 = 10; // 100ms
        dt_bypass_frames = dt_bypass_frames.max(short_window);
    }
}
```

**é¢„æœŸæ•ˆæœ**: æ ¹æ® render ä¿¡å·å¼ºåº¦è°ƒæ•´ä¿æŠ¤çª—å£ï¼Œå‡å°‘è¯¯åˆ¤

---

### å»ºè®® 3: å¢åŠ åŒè®²é€€å‡ºè¿‡æ¸¡æœŸï¼ˆä½ä¼˜å…ˆçº§ï¼‰

**ä½ç½®**: `audio/aec.rs:116`

**å½“å‰ä»£ç **:
```rust
self.dt_exit_frames = self.dt_exit_frames.max(8); // 80ms
```

**ä¿®å¤**:
```rust
self.dt_exit_frames = self.dt_exit_frames.max(15); // 150ms
```

**é¢„æœŸæ•ˆæœ**: æ›´å¹³æ»‘åœ°é€€å‡ºåŒè®²ä¿æŠ¤ï¼Œå‡å°‘çªç„¶åéŸ³

---

## ç›¸å…³ä»£ç ä½ç½®

- **åŒè®²æ£€æµ‹**: `capture.rs:1995-2012`
- **èƒ½é‡æ£€æµ‹**: `capture.rs:1995`
- **è‡ªé€‚åº”çª—å£**: `capture.rs:1998-2002`
- **è¡°å‡é€»è¾‘**: `capture.rs:2004-2011`
- **åŒè®²é€€å‡ºè¿‡æ¸¡**: `audio/aec.rs:114-123`
- **è‡ªåŠ¨å¼ºåŠ›æ¨¡å¼**: `capture.rs:2037-2039`

---

## æ€»ç»“

**å·²ä¿®å¤çš„é—®é¢˜**:
- âœ… åŒè®²ä¿æŠ¤çª—å£ï¼ˆä» 40ms å¢åŠ åˆ° 200-300msï¼‰
- âœ… åŸºäºèƒ½é‡çš„å¤‡ç”¨æ£€æµ‹
- âœ… æŒ‡æ•°è¡°å‡
- âœ… åŒè®²é€€å‡ºè¿‡æ¸¡

**ä»å­˜åœ¨çš„é—®é¢˜**:
- ğŸ”´ èƒ½é‡æ£€æµ‹é˜ˆå€¼ä¸å¤Ÿå‡†ç¡®ï¼Œå¯èƒ½è¯¯åˆ¤ï¼ˆæ²¡æœ‰æ£€æŸ¥ SNR å’Œèƒ½é‡å·®ï¼‰
- ğŸŸ¡ åŒè®²æ£€æµ‹æ²¡æœ‰è€ƒè™‘ render ä¿¡å·çš„èƒ½é‡

**ä¼˜åŒ–æ–¹å‘**:
1. æ”¹è¿›èƒ½é‡æ£€æµ‹ï¼Œæ·»åŠ  SNR å’Œèƒ½é‡å·®æ£€æŸ¥
2. è€ƒè™‘ render ä¿¡å·èƒ½é‡ï¼Œæ ¹æ®å¼ºåº¦è°ƒæ•´ä¿æŠ¤çª—å£
3. å¢åŠ åŒè®²é€€å‡ºè¿‡æ¸¡æœŸï¼ˆä» 80ms å¢åŠ åˆ° 150msï¼‰

