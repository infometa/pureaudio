========================================
  快速测试指南 v2.0
  修复：啸叫 + 吞字问题
========================================

修复内容：
1. ✅ AGC增益：15dB → 9dB（防止啸叫）
2. ✅ 双讲检测：对称±15dB → 非对称(-12,+6dB)（解决吞字）
3. ✅ 诊断日志：增强，显示场景和能量

编译：✅ 成功
版本：v3.1

========================================
  测试1：单讲（只有你说话）
========================================

目的：测试降噪、AGC等基础功能

配置：
  ✅ DeepFilterNet降噪
  ✅ 高通滤波器(80Hz)
  ✅ AGC自动增益
  ✅ VAD语音检测
  ✅ 最终限幅器
  ❌ AEC（可关闭）
  
播放设置：
  ❌ 关闭"自动播放测试音频" 或 静音
  
步骤：
  1. 点击"开始降噪"
  2. 等待2秒
  3. 对着麦克风正常说话
  4. 说30秒
  5. 点击"停止"
  6. 听 nc.wav

预期：
  ✅ 声音清晰，无吞字
  ✅ 音量稳定
  ✅ 低频噪音被过滤
  ✅ 无啸叫

日志示例：
  [INFO] 🎙️ AEC诊断 | 场景:仅近端说话 | VAD:✓ Render:✗

========================================
  测试2：双讲（你说话+扬声器播放）
========================================

目的：测试AEC回声消除 + 双讲保护

配置：
  ✅ DeepFilterNet降噪
  ✅ 高通滤波器(80Hz)
  ✅ AGC自动增益
  ✅ VAD语音检测
  ✅ AEC回声消除（必须开启）
  ✅ 最终限幅器
  
播放设置：
  ✅ 开启"自动播放测试音频"
  ⚠️  播放不要静音！（让扬声器正常发声）
  
步骤：
  1. 开启"自动播放测试音频"
  2. 调整音量到适中（不要太大）
  3. 点击"开始降噪"
  4. 等待2秒
  5. 在扬声器播放的同时，对着麦克风说话
  6. 测试30秒
  7. 点击"停止"
  8. 听 nc.wav

预期：
  ✅ 你的声音清晰可听（近端保护）
  ✅ 扬声器回声被消除（听不到或很小）
  ✅ 无吞字
  ✅ 无啸叫

日志示例：
  [INFO] 🎙️ AEC诊断 | 场景:双讲保护中 | VAD:✓ Render:✓ | 能量: Near=-25dB Far=-28dB Diff=+3dB | suppression=Low

========================================
  测试3：啸叫测试
========================================

目的：验证修复后无啸叫

配置：
  ✅ 使用默认配置（全部开启）
  
播放设置：
  ✅ 开启"自动播放测试音频"
  ✅ 音量开大（70-80%）
  ⚠️  播放不要静音！
  
步骤：
  1. 开启"自动播放测试音频"
  2. 音量调大
  3. 点击"开始降噪"
  4. 等待10秒
  5. 保持静音，不要说话
  6. 观察是否有尖锐的持续音

预期：
  ✅ 无啸叫声
  ✅ 音量稳定
  ✅ 只听到扬声器播放的音乐

如果仍有啸叫：
  1. 降低音量到50%
  2. 调整"回声延迟补偿"（UI上的滑块）
     - 从60ms开始
     - 尝试40ms、80ms、100ms
  3. 观察日志中的能量值

========================================
  日志解读
========================================

日志格式：
  🎙️ AEC诊断 | 场景:XXX | VAD:✓/✗ Render:✓/✗ | 能量: Near=XXdB Far=XXdB Diff=XXdB | suppression=XXX

场景类型：
  - 双讲保护中：Near和Far能量相当
  - 近端占优：你说话声音很大
  - 远端占优：扬声器声音很大
  - 仅近端说话：只有你说话
  - 仅远端播放：只有扬声器播放
  - 静音：都没有

能量值（dB）：
  - Near：麦克风拾取的能量（包括你的声音+回声）
  - Far：扬声器播放的能量
  - Diff：Near - Far（能量差）

正常范围：
  - Near：-20 ~ -40 dB（说话时）
  - Far：-20 ~ -35 dB（播放时）
  - Diff：
    - > +6dB：近端占优
    - -12 ~ +6dB：双讲
    - < -12dB：远端占优

抑制级别：
  - Low：双讲时，弱抑制，保护近端
  - Moderate：过渡期，中等抑制
  - High：单讲时，强抑制，消除回声

========================================
  常见问题
========================================

Q1: 双讲测试时，播放要不要静音？
A1: ❌ 不要静音！播放要正常发声，才能产生回声，测试AEC效果。

Q2: 单讲测试时，播放要不要静音？
A2: ✅ 要静音 或 关闭"自动播放"。单讲只测试你的声音。

Q3: 仍然有吞字怎么办？
A3: 1. 检查日志中的Diff值
    2. 如果Diff > +6dB但仍吞字，说明VAD或AEC延迟有问题
    3. 尝试调整"回声延迟补偿"

Q4: 仍然有啸叫怎么办？
A4: 1. 降低音量到50%
    2. 调整"回声延迟补偿"（最关键！）
    3. 降低AGC最大增益（UI参数，从12降到6）
    4. 观察日志，确认Far能量是否正常

Q5: 远端音频还是能听到怎么办？
A5: 1. 检查日志中的Far能量
    2. 如果Far > -20dB（很大），可能是扬声器音量太大
    3. 调整"回声延迟补偿"
    4. 如果Diff < -12dB（远端占优），AEC会全力消除

Q6: 如何知道AEC延迟是否准确？
A6: 观察日志：
    - 如果Far能量正常，但回声很大 → 延迟不准
    - 尝试调整±20ms
    - 找到回声最小的延迟值

========================================
  配置建议
========================================

日常使用（单讲）：
  ✅ DeepFilterNet降噪
  ✅ 高通滤波器(80Hz)
  ✅ AGC自动增益
  ✅ VAD语音检测
  ✅ 最终限幅器
  ❌ AEC（不需要）
  ❌ 音色修复（可选，有延迟）

会议/直播（双讲）：
  ✅ DeepFilterNet降噪
  ✅ 高通滤波器(80Hz)
  ✅ AGC自动增益
  ✅ VAD语音检测
  ✅ AEC回声消除（必须）
  ✅ 最终限幅器
  ❌ 音色修复（可选，有延迟）

高音质录音：
  ✅ DeepFilterNet降噪（降噪抑制30dB）
  ✅ 高通滤波器(80Hz)
  ❌ AGC（保持动态）
  ✅ 最终限幅器（防削波）
  ❌ AEC（不需要）
  ✅ 音色修复（可选）

========================================
  技术参数
========================================

AGC配置（修复后）：
  - target_level_dbfs: 16（-16 dBFS）
  - compression_gain_db: 9（9dB增益）
  - 修复前：12 / 15dB

双讲检测阈值（修复后）：
  - 近端保护：> +6dB
  - 真双讲：-12 ~ +6dB
  - 远端占优：< -12dB
  - 修复前：对称±15dB

其他默认值：
  - 高通频率：80Hz
  - AEC延迟：60ms（可调）
  - VAD阈值：动态调整
  - 启动保护：2秒

========================================

修复完成时间：2025-12-11
版本：v3.1
状态：✅ 已修复并编译成功

现在可以测试了！

有问题请查看详细文档：
  - 啸叫和吞字问题修复方案.md
  - UI状态同步修复说明.md
  - 开箱即用配置说明.md

========================================
