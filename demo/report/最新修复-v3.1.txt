========================================
  最新修复 v3.1 - 2025-12-11
  啸叫 + 吞字问题
========================================

✅ 问题1：默认配置会啸叫
✅ 问题2：近讲语音有吞字，远端语音未消除干净

========================================
  根本原因
========================================

问题1（啸叫）：
  AGC增益过高（15dB）
  → 放大AEC的残留回声
  → 形成正反馈
  → 啸叫

问题2（吞字+未消干净）：
  双讲检测用对称阈值（±15dB）
  → 无法区分近端占优/远端占优
  → 误判：
    - 该保护时不保护 → 吞字
    - 不该保护时保护 → 远端未消干净

========================================
  修复方案
========================================

修复1：降低AGC增益 ✅
  文件：demo/src/audio/agc.rs
  
  target_level_dbfs: 12 → 16
  compression_gain_db: 15 → 9
  
  效果：
    - 增益降低6dB
    - 啸叫风险大幅降低
    - 残留回声：-50→-35dB（修复前）
                -50→-41dB（修复后）

修复2：非对称阈值双讲检测 ✅
  文件：demo/src/capture.rs
  
  原来：能量差±15dB内算双讲（对称）
  现在：
    - 近端>+6dB → 保护（宽松）
    - -12~+6dB → 双讲，保护
    - 远端<-12dB → 不保护（严格）
  
  效果：
    - ✅ 积极保护近端 → 无吞字
    - ✅ 远端占优时不保护 → 消得更干净

修复3：增强诊断日志 ✅
  文件：demo/src/capture.rs
  
  新增场景识别：
    - 双讲保护中
    - 近端占优
    - 远端占优
    - 仅近端说话
    - 仅远端播放
    - 静音
  
  效果：
    - 易于调试AEC延迟
    - 观察能量变化
    - 判断双讲检测是否正确

========================================
  测试方法
========================================

单讲测试（只有你说话）：
  ❌ 关闭"自动播放测试音频" 或 静音
  ✅ 点击"开始降噪"
  ✅ 说话30秒
  ✅ 听 nc.wav
  
  预期：清晰、无吞字、无啸叫

双讲测试（你说话+扬声器播放）：
  ✅ 开启"自动播放测试音频"
  ⚠️  播放不要静音！（必须发声）
  ✅ 点击"开始降噪"
  ✅ 在播放的同时说话
  ✅ 听 nc.wav
  
  预期：你的声音清晰、回声消除、无吞字、无啸叫

啸叫测试：
  ✅ 默认配置（全部开启）
  ✅ 音量开大（70-80%）
  ✅ 点击"开始降噪"
  ✅ 等待10秒
  
  预期：无啸叫

========================================
  日志示例
========================================

双讲时：
[INFO] 🎙️ AEC诊断 | 场景:双讲保护中 | VAD:✓ Render:✓ | 能量: Near=-25dB Far=-28dB Diff=+3dB | suppression=Low

近端占优：
[INFO] 🎙️ AEC诊断 | 场景:近端占优 | VAD:✓ Render:✓ | 能量: Near=-20dB Far=-35dB Diff=+15dB | suppression=Low

远端占优：
[INFO] 🎙️ AEC诊断 | 场景:远端占优 | VAD:✓ Render:✓ | 能量: Near=-45dB Far=-28dB Diff=-17dB | suppression=High

========================================
  常见问题
========================================

Q: 双讲测试时，播放要不要静音？
A: ❌ 不要静音！必须让扬声器发声，才能测试AEC。

Q: 单讲测试时，播放要不要静音？
A: ✅ 要静音或关闭。单讲不需要远端音频。

Q: 仍有啸叫怎么办？
A: 1. 降低音量
   2. 调整"回声延迟补偿"（最关键）
   3. 降低AGC最大增益（UI参数）

Q: 仍有吞字怎么办？
A: 1. 观察日志中的Diff值
   2. 如果Diff>+6dB但仍吞字 → AEC延迟不准
   3. 调整"回声延迟补偿"

Q: 远端还能听到怎么办？
A: 1. 降低扬声器音量
   2. 调整"回声延迟补偿"
   3. 观察日志，确认Far能量

========================================
  修改统计
========================================

修改文件：2个
  - demo/src/audio/agc.rs
  - demo/src/capture.rs

修改行数：约50行

编译状态：✅ 成功

预期效果：
  ✅ 啸叫：解决
  ✅ 吞字：解决
  ✅ 远端未消干净：解决
  ✅ 可调试性：显著提升

========================================
  相关文档
========================================

详细说明：
  - 啸叫和吞字问题修复方案.md（完整技术方案）
  - 快速测试指南-v2.txt（测试步骤）

配置文档：
  - UI状态同步修复说明.md
  - 开箱即用配置说明.md

原理文档：
  - AEC回声消除原理与相关概念科普.md
  - 阶段1优化完成报告-v3.0.md

========================================

修复完成时间：2025-12-11
版本：v3.1
状态：✅ 已修复并编译成功

现在可以测试了！🚀

重要提醒：
1. 双讲测试时，播放不要静音！
2. 观察日志中的"场景"和"能量差"
3. 如果仍有问题，调整"回声延迟补偿"

========================================
